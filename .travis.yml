os: linux
dist: xenial
language: php

script:
  - composer install
  - cd e2e
  - composer install
  - php testPharAutoloader.php
  - vendor/bin/phpunit PharTest.php

jobs:
  include:
    - stage: Tests
      php: 7.1

    - stage: Tests
      php: 7.2

    - stage: Tests
      php: 7.3

    - stage: Tests
      php: 7.4snapshot

    - stage: Tests
      os: windows
      dist: 1803-containers
      language: sh # No PHP currently
      env: PHP_VERSION=7.1.32
      install:
        - choco install php --version=${PHP_VERSION} --package-parameters="/InstallDir:c:\tools\php"
        - choco install composer --ia "/DEV=C:\tools\php"
        - export PATH=/c/tools/php:$PATH

    - stage: Tests
      os: windows
      dist: 1803-containers
      language: sh # No PHP currently
      env: PHP_VERSION=7.2.23
      install:
        - choco install php --version=${PHP_VERSION} --package-parameters="/InstallDir:c:\tools\php"
        - choco install composer --ia "/DEV=C:\tools\php"
        - export PATH=/c/tools/php:$PATH

    - stage: Tests
      os: windows
      dist: 1803-containers
      language: sh # No PHP currently
      env: PHP_VERSION=7.3.10
      install:
        - choco install php --version=${PHP_VERSION} --package-parameters="/InstallDir:c:\tools\php"
        - choco install composer --ia "/DEV=C:\tools\php"
        - export PATH=/c/tools/php:$PATH

    - stage: Extension Tests
      name: phpstan-phpunit
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-phpunit.git'

    - stage: Extension Tests
      name: phpstan-strict-rules
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-strict-rules.git'

    - stage: Extension Tests
      name: phpstan-mockery
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-mockery.git'

    - stage: Extension Tests
      name: phpstan-doctrine
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-doctrine.git'

    - stage: Extension Tests
      name: phpstan-symfony
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-symfony.git'

    - stage: Extension Tests
      name: phpstan-php-parser
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-php-parser.git'

    - stage: Extension Tests
      name: phpstan-deprecation-rules
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-deprecation-rules.git'

    - stage: Extension Tests
      name: phpdoc-parser
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpdoc-parser.git'

    - stage: Extension Tests
      name: phpstan-nette
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-nette.git'

    - stage: Extension Tests
      name: phpstan-dibi
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-dibi.git'

    - stage: Extension Tests
      name: phpstan-webmozart-assert
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-webmozart-assert.git'

    - stage: Extension Tests
      name: phpstan-beberlei-assert
      script:
        - ./e2e/test-extension.sh 'https://github.com/phpstan/phpstan-beberlei-assert.git'

    - stage: Draft The Release
      script: []
      deploy:
        - provider: releases
          api_key:
            secure: 3qGfBd4BPl2bh0TfirFYCWqFUKKFnmB6hGcKyl/D88NtvCHV439emIc9n5WBaaVEGHSJEPAGgIEsyv/WoSsiTTStHjaeckO/zwoCvbMWPtsCXQqB6wn363pcGe9ZPFayO96UJJ/udcdsZ64F68Ibw46BNqnVwG0Yo1bkpn3oYK5U8I388o5chA1IF472i6zYVTBhJczgzMt1YpDejkJ/MXupIp6TJSL6NqVfRmQtIyTL15HQkr1NJIVlN6dIkbjTDiOEk9nAu4vGxaV3RtURXEe8iM86+ezR0F36jdI/QoIn8WhkR1j6pgh3aRtRVylu8J1FOee5eOs2PU4terFcgpYnDN5mPBEAVkF6D/cxuLybfbyvcl36qJb6wndfL2g/fTVSw95k75DRJTfYAmFHYhB5pk672i9OGgLGBlVrgIRk4MyZB/JSFPoACMHRCOxKQq1Mjrepw9mxCamxRNVUs2w/ERiq5JZg7sWFF6QYAAL2gowwgTu9ezvAVDaYhDJR0KMvG3bL+tzzrAN8YNOghDXa6knlP2QhnMBbsiE0py+02QxVG+fIYMEVpsCNBYuHvPxqr2kafCnCOanFG3BslsL8SIQ4F2eFRFX5cXrrl9Po+R/ZzaCsUrlt7DILRqbr+iLJvMDbfg3CzhBqm/NCJVMUy0HaW2xdvX2I3dQLrDY=
          file:
            - phpstan.phar
            - phpstan.phar.asc
          skip_cleanup: true
          draft: true
          name: $TRAVIS_TAG
          on:
            tags: true

cache:
  directories:
    - $HOME/.composer/cache
